services:
  nextcloud:
    profiles: ["nextcloud"]
    build: .
    image: nextcloud-custom:ffmpeg
    container_name: nextcloud
    restart: unless-stopped
    networks: [frontend, nextcloud-backend]
    env_file:
      - ../.env
      - ./.env
      - ./.env.secrets 
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - ${DATA_DIR}/nextcloud/html:/var/www/html
      - ${DATA_DIR}/nextcloud/data:/var/www/html/data

  nextcloud-cron:
    profiles: ["nextcloud"]
    image: nextcloud-custom:ffmpeg
    container_name: nextcloud-cron
    restart: unless-stopped
    networks: [nextcloud-backend]
    depends_on: [nextcloud]
    entrypoint: /cron.sh
    env_file:
      - ../.env
      - ./.env
    volumes:
      - ${DATA_DIR}/nextcloud/html:/var/www/html
      - ${DATA_DIR}/nextcloud/data:/var/www/html/data

  mariadb:
    profiles: ["nextcloud"]
    image: mariadb:10.11
    container_name: mariadb
    restart: unless-stopped
    networks: [nextcloud-backend]
    env_file:
      - ../.env
      - ./.env
      - ./.env.secrets
    command:
      - --transaction-isolation=READ-COMMITTED
      - --binlog-format=ROW
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - ${DATA_DIR}/nextcloud/db:/var/lib/mysql

  redis:
    profiles: ["nextcloud"]
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks: [nextcloud-backend]
    env_file:
      - ../.env
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
    volumes:
      - ${DATA_DIR}/nextcloud/redis:/data
 
